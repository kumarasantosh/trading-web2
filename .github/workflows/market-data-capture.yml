# This file was auto-generated by setup-github-actions.sh
# You can customize it as needed

name: Market Data Auto-Capture

on:
  schedule:
    # Every minute during market hours (9:15 AM - 3:30 PM IST = 3:45 AM - 10:00 AM UTC)
    - cron: '*/1 3-10 * * 1-5'
  
  workflow_dispatch:
    inputs:
      capture_type:
        description: 'Type of capture'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - market-data
          - option-chain
          - stock-snapshots
          - breakouts
          - pcr
          - eod

env:
  VERCEL_URL: ${{ secrets.VERCEL_URL || 'https://trading-web2.vercel.app' }}

jobs:
  trigger-captures:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Determine tasks to run
        id: tasks
        run: |
          MINUTE=$(date +%M)
          HOUR=$(date +%H)
          CAPTURE_TYPE="${{ github.event.inputs.capture_type || 'all' }}"
          
          # Market data: every minute
          if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "market-data" ]; then
            echo "run_market=true" >> $GITHUB_OUTPUT
          fi
          
          # OI data: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "option-chain" ]; then
              echo "run_oi=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Stock snapshots: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "stock-snapshots" ]; then
              echo "run_snapshots=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Breakout snapshots: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "breakouts" ]; then
              echo "run_breakouts=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # PCR: every minute
          if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "pcr" ]; then
            echo "run_pcr=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Capture market data
        if: steps.tasks.outputs.run_market == 'true'
        run: |
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/capture-market-data" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            --retry 2 \
            -f -v

      - name: ðŸ“ˆ Capture option chain OI
        if: steps.tasks.outputs.run_oi == 'true'
        continue-on-error: true
        run: |
          curl -X GET "${{ env.VERCEL_URL }}/api/option-chain/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            -f -v

      - name: ðŸ“¸ Update stock snapshots
        if: steps.tasks.outputs.run_snapshots == 'true'
        continue-on-error: true
        run: |
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/update-stock-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            -f -v

      - name: ðŸŽ¯ Update breakout snapshots
        if: steps.tasks.outputs.run_breakouts == 'true'
        continue-on-error: true
        run: |
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/update-breakout-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            -f -v

      - name: ï¿½ï¿½ Calculate PCR
        if: steps.tasks.outputs.run_pcr == 'true'
        continue-on-error: true
        run: |
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/calculate-pcr" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            -f -v
