# .github/workflows/market-data-capture.yml
name: Market Data Auto-Capture

on:
  schedule:
    # Every minute during market hours (9:15 AM - 3:30 PM IST = 3:45 AM - 10:00 AM UTC)
    - cron: '*/1 3-10 * * 1-5'
  
  workflow_dispatch:
    inputs:
      capture_type:
        description: 'Type of capture'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - market-data
          - option-chain
          - stock-snapshots
          - breakouts
          - pcr
          - eod
          - cleanup

env:
  VERCEL_URL: ${{ secrets.VERCEL_URL || 'https://trading-web2.vercel.app' }}

jobs:
  trigger-captures:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Determine tasks to run
        id: tasks
        run: |
          MINUTE=$(date +%M)
          HOUR=$(date +%H)
          CAPTURE_TYPE="${{ github.event.inputs.capture_type || 'all' }}"
          
          echo "Current time: $HOUR:$MINUTE UTC"
          
          # Cleanup: Run once at start of day (9:15 AM IST = 3:45 AM UTC)
          if [ "$HOUR" -eq 3 ] && [ "$MINUTE" -eq 45 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "cleanup" ]; then
              echo "run_cleanup=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Market data: every minute
          if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "market-data" ]; then
            echo "run_market=true" >> $GITHUB_OUTPUT
          fi
          
          # OI data: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "option-chain" ]; then
              echo "run_oi=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Stock snapshots: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "stock-snapshots" ]; then
              echo "run_snapshots=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Breakout snapshots: every 3 minutes
          if [ $((MINUTE % 3)) -eq 0 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "breakouts" ]; then
              echo "run_breakout_snapshots=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Breakout check: every minute
          if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "breakouts" ]; then
            echo "run_breakout_check=true" >> $GITHUB_OUTPUT
          fi
          
          # PCR: every minute
          if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "pcr" ]; then
            echo "run_pcr=true" >> $GITHUB_OUTPUT
          fi
          
          # EOD daily high-low: 3:35 PM IST (10:05 AM UTC)
          if [ "$HOUR" -eq 10 ] && [ "$MINUTE" -ge 5 ] && [ "$MINUTE" -lt 10 ]; then
            if [ "$CAPTURE_TYPE" = "all" ] || [ "$CAPTURE_TYPE" = "eod" ]; then
              echo "run_eod=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: üßπ Cleanup intraday data (start of day)
        if: steps.tasks.outputs.run_cleanup == 'true'
        continue-on-error: true
        run: |
          echo "üßπ Cleaning up previous day's intraday data..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/cleanup-intraday" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Cleanup complete"
          else
            echo "‚ö†Ô∏è Cleanup returned HTTP $http_code"
          fi

      - name: üìä Capture market data (sectors)
        if: steps.tasks.outputs.run_market == 'true'
        continue-on-error: true
        run: |
          echo "üìä Capturing market data (sectors)..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/capture-market-data" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 \
            --retry 2)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            sectors=$(echo "$body" | grep -o '"sectors_captured":[0-9]*' | cut -d':' -f2)
            echo "‚úÖ Market Data: $sectors sectors captured"
          else
            echo "‚ùå Failed with HTTP $http_code"
            echo "$body"
          fi

      - name: üìà Capture option chain OI data
        if: steps.tasks.outputs.run_oi == 'true'
        continue-on-error: true
        run: |
          echo "üìà Capturing option chain OI data..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/option-chain/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            # Check if skipped
            message=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            if [ "$message" = "Outside market hours" ]; then
              echo "‚è≠Ô∏è  Skipped (outside market hours)"
            else
              symbol=$(echo "$body" | grep -o '"symbol":"[^"]*"' | cut -d'"' -f4)
              putOI=$(echo "$body" | grep -o '"total_put_oi":[0-9]*' | cut -d':' -f2)
              callOI=$(echo "$body" | grep -o '"total_call_oi":[0-9]*' | cut -d':' -f2)
              echo "‚úÖ Option Chain: $symbol - Put OI: $putOI, Call OI: $callOI"
            fi
          else
            echo "‚ùå Failed with HTTP $http_code"
          fi

      - name: üì∏ Update stock snapshots (top movers)
        if: steps.tasks.outputs.run_snapshots == 'true'
        continue-on-error: true
        run: |
          echo "üì∏ Updating stock snapshots..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/update-stock-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            # Check if skipped
            message=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$message" ]; then
              echo "‚è≠Ô∏è  $message"
            else
              stocks_updated=$(echo "$body" | grep -o '"stocks_updated":[0-9]*' | cut -d':' -f2)
              stocks_processed=$(echo "$body" | grep -o '"stocks_processed":[0-9]*' | cut -d':' -f2)
              echo "‚úÖ Stock Snapshots: $stocks_updated/$stocks_processed stocks updated"
            fi
          else
            echo "‚ùå Failed with HTTP $http_code"
          fi

      - name: üéØ Update breakout snapshots
        if: steps.tasks.outputs.run_breakout_snapshots == 'true'
        continue-on-error: true
        run: |
          echo "üéØ Updating breakout snapshots..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/update-breakout-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            updated=$(echo "$body" | grep -o '"updated":[0-9]*' | cut -d':' -f2)
            breakouts=$(echo "$body" | grep -o '"breakouts":[0-9]*' | cut -d':' -f2)
            breakdowns=$(echo "$body" | grep -o '"breakdowns":[0-9]*' | cut -d':' -f2)
            echo "‚úÖ Breakout Snapshots: $updated stocks ($breakouts breakouts, $breakdowns breakdowns)"
          else
            echo "‚ùå Failed with HTTP $http_code"
          fi

      - name: üîç Check breakouts/breakdowns
        if: steps.tasks.outputs.run_breakout_check == 'true'
        continue-on-error: true
        run: |
          echo "üîç Checking for breakouts/breakdowns..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/check-breakouts" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            # Check if skipped
            message=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$message" ]; then
              echo "‚è≠Ô∏è  $message"
            else
              breakouts=$(echo "$body" | grep -o '"breakouts_detected":[0-9]*' | cut -d':' -f2)
              breakdowns=$(echo "$body" | grep -o '"breakdowns_detected":[0-9]*' | cut -d':' -f2)
              stocks_checked=$(echo "$body" | grep -o '"stocks_checked":[0-9]*' | cut -d':' -f2)
              echo "‚úÖ Breakout Check: $stocks_checked stocks - $breakouts breakouts, $breakdowns breakdowns"
            fi
          else
            echo "‚ùå Failed with HTTP $http_code"
          fi

      - name: üìä Calculate PCR (Put-Call Ratio)
        if: steps.tasks.outputs.run_pcr == 'true'
        continue-on-error: true
        run: |
          echo "üìä Calculating PCR..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/calculate-pcr" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            # Check if skipped
            message=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$message" ]; then
              echo "‚è≠Ô∏è  $message"
            else
              pcr_calculated=$(echo "$body" | grep -o '"pcr_calculated":[0-9]*' | cut -d':' -f2)
              indices=$(echo "$body" | grep -o '"indices_processed":[0-9]*' | cut -d':' -f2)
              if [ -n "$pcr_calculated" ]; then
                echo "‚úÖ PCR: $pcr_calculated indices calculated"
              elif [ -n "$indices" ]; then
                echo "‚úÖ PCR: $indices indices processed"
              else
                echo "‚úÖ PCR calculation completed"
              fi
            fi
          else
            echo "‚ùå Failed with HTTP $http_code"
          fi

      - name: üèÅ Capture daily high-low (EOD)
        if: steps.tasks.outputs.run_eod == 'true'
        continue-on-error: true
        run: |
          echo "üèÅ Capturing daily high-low (End of Day)..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -X GET "${{ env.VERCEL_URL }}/api/cron/save-daily-high-low" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 60)
          
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "$http_code" = "200" ]; then
            stocks_captured=$(echo "$body" | grep -o '"stocks_captured":[0-9]*' | cut -d':' -f2)
            stocks_inserted=$(echo "$body" | grep -o '"stocks_inserted":[0-9]*' | cut -d':' -f2)
            echo "‚úÖ Daily High-Low: $stocks_inserted stocks saved (fetched: $stocks_captured)"
          else
            echo "‚ùå Failed with HTTP $http_code"
            echo "$body"
          fi

      - name: üìã Workflow Summary
        if: always()
        run: |
          echo "==================================="
          echo "Workflow Execution Summary"
          echo "==================================="
          echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Capture Type: ${{ github.event.inputs.capture_type || 'all (scheduled)' }}"
          echo "==================================="