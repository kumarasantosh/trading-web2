# .github/workflows/market-data-capture.yml
name: Market Data Auto-Capture

on:
  schedule:
    # Every minute from 9:15 AM to 3:30 PM IST (3:45 AM - 10:00 AM UTC)
    # Monday to Friday
    - cron: '45-59 3 * * 1-5'    # 3:45-3:59 AM UTC
    - cron: '* 4-9 * * 1-5'       # 4:00-9:59 AM UTC
    - cron: '0-30 10 * * 1-5'     # 10:00-10:30 AM UTC
  
  workflow_dispatch:

env:
  VERCEL_URL: ${{ secrets.VERCEL_URL || 'https://trading-web2.vercel.app' }}

jobs:
  trigger-captures:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: â° Check schedule and determine tasks
        id: schedule
        run: |
          MINUTE=$(date +%M)
          HOUR=$(date +%H)
          
          echo "=== Current Time: $HOUR:$MINUTE UTC ==="
          
          # EVERY MINUTE (60 seconds interval):
          echo "run_market=true" >> $GITHUB_OUTPUT          # Market data
          echo "run_breakout_check=true" >> $GITHUB_OUTPUT  # Breakout check
          echo "run_pcr=true" >> $GITHUB_OUTPUT             # PCR calculation
          
          # EVERY 3 MINUTES (180 seconds interval):
          if [ $((MINUTE % 3)) -eq 0 ]; then
            echo "run_oi=true" >> $GITHUB_OUTPUT              # Option chain
            echo "run_snapshots=true" >> $GITHUB_OUTPUT       # Stock snapshots
            echo "run_breakout_snapshots=true" >> $GITHUB_OUTPUT  # Breakout snapshots
          fi
          
          # ONCE AT START OF DAY (9:15 AM IST = 3:45 AM UTC):
          if [ "$HOUR" -eq 3 ] && [ "$MINUTE" -eq 45 ]; then
            echo "run_cleanup=true" >> $GITHUB_OUTPUT
          fi
          
          # ONCE AT EOD (3:30 PM IST = 10:00 AM UTC):
          if [ "$HOUR" -eq 10 ] && [ "$MINUTE" -eq 0 ]; then
            echo "run_eod=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§¹ Cleanup intraday data
        if: steps.schedule.outputs.run_cleanup == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ§¹ Cleaning up previous day's intraday data..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/cleanup-intraday" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ“Š Capture market data (every 1 min)
        if: steps.schedule.outputs.run_market == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ“Š Capturing market data (sectors)..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/capture-market-data" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 --retry 2 -v

      - name: ğŸ” Check breakouts/breakdowns (every 1 min)
        if: steps.schedule.outputs.run_breakout_check == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ” Checking breakouts/breakdowns..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/check-breakouts" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ“Š Calculate PCR (every 1 min)
        if: steps.schedule.outputs.run_pcr == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ“Š Calculating PCR..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/calculate-pcr" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ“ˆ Capture option chain OI (every 3 min)
        if: steps.schedule.outputs.run_oi == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ“ˆ Capturing option chain OI data..."
          curl -X GET "${{ env.VERCEL_URL }}/api/option-chain/cron" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ“¸ Update stock snapshots (every 3 min)
        if: steps.schedule.outputs.run_snapshots == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ“¸ Updating stock snapshots..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/update-stock-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ¯ Update breakout snapshots (every 3 min)
        if: steps.schedule.outputs.run_breakout_snapshots == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ¯ Updating breakout snapshots..."
          curl -X GET "${{ env.VERCEL_URL }}/api/cron/update-breakout-snapshots" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            --max-time 30 -v

      - name: ğŸ Populate daily high-low from yfinance (Start of Day)
        if: steps.schedule.outputs.run_cleanup == 'true'
        continue-on-error: true
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ğŸ Running Python script to fetch yesterday's OHLC data from yfinance..."
          
          # Install required Python packages
          pip install yfinance python-dotenv supabase --quiet
          
          # Set environment variables from secrets
          export NEXT_PUBLIC_SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
          export SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          
          # Run the Python script
          python3 populate_daily_high_low.py